#!/bin/bash

set -e

if [ -n "${DOTFILES_DEBUG}" ];
then
  set -x
fi

echo '--> Fetch latest dotfiles'
for dir in "${DOTFILES_ROOT}"/*;
do
	if [ -d "${dir}/.git" ];
  then
    (cd "${dir}"; git pull --quiet)
  fi
done

echo '--> Update latest dotfiles'
rcup

echo '--> Keep Homebrew up-to-date'
$(command -v brew) upgrade || true
$(command -v brew) cask upgrade || true
$(command -v brew) cleanup || true

echo "--> Updating Brews"
shopt -s nullglob
for brewfile in "${DOTFILES_ROOT}"/{itsmycargo,local}/Brewfile;
do
  [ -e "${brewfile}" ] && $(command -v brew) bundle install --file="${brewfile}" || true
done
shopt -u nullglob

# Run additional update scripts
echo "--> Post-Update Scripts"
shopt -s nullglob
for script in "${DOTFILES_ROOT}"/{itsmycargo,local}/post-update.d/*.sh;
do
  sh "${script}"
done
shopt -u nullglob
